---
title: "Shameless Baseball Love"
output: html_document
---

```{r, warning=FALSE, echo=FALSE, error=FALSE}
fans.bat <- read.csv('../../../Data/Fans_batters.csv')
steamer.bat <- read.csv('../../../Data//Steamer_batters.csv')
zips.bat <- read.csv('../../../Data/ZIPS_batters.csv')
fans.pit <- read.csv('../../../Data//Fans_pitchers.csv')
steamer.pit <- read.csv('../../../Data/Steamer_pitchers.csv')
zips.pit <- read.csv('../../../Data/ZIPS_pitchers.csv')

library(dplyr)
#Rename variables so I know where they come from
names(fans.bat)[1:24] <- paste('fans', names(fans.bat)[1:24], sep='_')
names(steamer.bat)[1:29] <- paste('steamer', names(steamer.bat)[1:29],
                                  sep='_')
names(zips.bat)[1:24] <- paste('zips', names(zips.bat)[1:24], sep='_')
#join by player id
bat <- full_join(fans.bat, steamer.bat, by='playerid')
bat <- full_join(bat, zips.bat, by='playerid')

#repeat for pitching
names(fans.pit)[1:19] <- paste('fans', names(fans.pit)[1:19], sep='_')
names(steamer.pit)[1:20] <- paste('steamer', names(steamer.pit)[1:20],
                                  sep='_')
names(zips.pit)[1:18] <- paste('zips', names(zips.pit)[1:18], sep='_')
#join by player id
pit <- full_join(fans.pit, steamer.pit, by='playerid')
pit <- full_join(pit, zips.pit, by='playerid')

##Batting stats
bat$agg.runs <- apply(bat[,c('fans_R', 'steamer_R', 'fans_R')], 1,
                    function(x) mean(x, na.rm=T))
bat$agg.hr <- apply(bat[,c('fans_HR', 'steamer_HR', 'fans_HR')], 1,
                    function(x) mean(x, na.rm=T))
bat$agg.rbi <- apply(bat[,c('fans_RBI', 'steamer_RBI', 'fans_RBI')], 1,
                    function(x) mean(x, na.rm=T))
bat$agg.sb <- apply(bat[,c('fans_SB', 'steamer_SB', 'fans_SB')], 1,
                    function(x) mean(x, na.rm=T))
bat$agg.obp <- apply(bat[,c('fans_OBP', 'steamer_OBP', 'fans_OBP')], 1,
                    function(x) mean(x, na.rm=T))
#Singles are a bit trickier...
bat$fans_1b <- bat$fans_H - (bat$fans_X2B + bat$fans_X3B + bat$fans_HR)
bat$steamer_1b <- bat$steamer_H - (bat$steamer_X2B + bat$steamer_X3B +
                                     bat$steamer_HR)
bat$zips_1b <- bat$zips_H - (bat$zips_X2B + bat$zips_X3B + bat$zips_HR)
bat$agg.1b <- apply(bat[,c('fans_1b', 'steamer_1b', 'fans_1b')], 1,
                    function(x) mean(x, na.rm=T))
bat$agg.2b <- apply(bat[,c('fans_X2B', 'steamer_X2B', 'fans_X2B')], 1, 
                    function(x) mean(x, na.rm=T))
bat$agg.3b <- apply(bat[,c('fans_X3B', 'steamer_X3B', 'fans_X3B')], 1,
                    function(x) mean(x, na.rm=T))
bat$agg.bb <- apply(bat[,c('fans_BB', 'steamer_BB', 'fans_BB')], 1,
                    function(x) mean(x, na.rm=T))
bat$agg.avg <- apply(bat[,c('fans_AVG', 'steamer_AVG', 'fans_AVG')], 1,
                    function(x) mean(x, na.rm=T))
bat$agg.obp <- apply(bat[,c('fans_OBP', 'steamer_OBP', 'fans_OBP')], 1,
                    function(x) mean(x, na.rm=T))
bat$agg.ops <- apply(bat[,c('fans_OPS', 'steamer_OPS', 'fans_OPS')], 1,
                    function(x) mean(x, na.rm=T))

##Pitching stats
pit$agg.w <- apply(pit[,c('fans_W', 'steamer_W', 'zips_W')], 1, function(x) 
                    mean(x, na.rm=T))
#zips doesn't forecast saves
pit$agg.sv <- apply(pit[,c('fans_SV', 'steamer_SV')], 1, function(x) 
                    mean(x, na.rm=T))
pit$agg.k <- apply(pit[,c('fans_SO', 'steamer_SO', 'zips_SO')], 1, function(x) 
                    mean(x, na.rm=T))
pit$agg.era <- apply(pit[,c('fans_ERA', 'steamer_ERA', 'zips_ERA')], 1, 
                     function(x) mean(x, na.rm=T))
pit$agg.whip <- apply(pit[,c('fans_WHIP', 'steamer_WHIP', 'zips_WHIP')], 1,
                      function(x) mean(x, na.rm=T))

bat$agg.sd.runs <- apply(bat[,c('fans_R', 'steamer_R', 'fans_R')], 1,
                    function(x) sd(x, na.rm=T))
bat$agg.sd.hr <- apply(bat[,c('fans_HR', 'steamer_HR', 'fans_HR')], 1,
                    function(x) sd(x, na.rm=T))
bat$agg.sd.rbi <- apply(bat[,c('fans_RBI', 'steamer_RBI', 'fans_RBI')], 1,
                    function(x) sd(x, na.rm=T))
bat$agg.sd.sb <- apply(bat[,c('fans_SB', 'steamer_SB', 'fans_SB')], 1,
                    function(x) sd(x, na.rm=T))
bat$agg.sd.obp <- apply(bat[,c('fans_OBP', 'steamer_OBP', 'fans_OBP')], 1,
                    function(x) sd(x, na.rm=T))
#Singles are a bit trickier...
bat$fans_1b <- bat$fans_H - (bat$fans_X2B + bat$fans_X3B + bat$fans_HR)
bat$steamer_1b <- bat$steamer_H - (bat$steamer_X2B + bat$steamer_X3B +
                                     bat$steamer_HR)
bat$zips_1b <- bat$zips_H - (bat$zips_X2B + bat$zips_X3B + bat$zips_HR)
bat$agg.sd.1b <- apply(bat[,c('fans_1b', 'steamer_1b', 'fans_1b')], 1,
                    function(x) sd(x, na.rm=T))
bat$agg.sd.2b <- apply(bat[,c('fans_X2B', 'steamer_X2B', 'fans_X2B')], 1, 
                    function(x) sd(x, na.rm=T))
bat$agg.sd.3b <- apply(bat[,c('fans_X3B', 'steamer_X3B', 'fans_X3B')], 1,
                    function(x) sd(x, na.rm=T))
bat$agg.sd.bb <- apply(bat[,c('fans_BB', 'steamer_BB', 'fans_BB')], 1,
                    function(x) sd(x, na.rm=T))
bat$agg.sd.avg <- apply(bat[,c('fans_AVG', 'steamer_AVG', 'fans_AVG')], 1,
                    function(x) sd(x, na.rm=T))
bat$agg.sd.obp <- apply(bat[,c('fans_OBP', 'steamer_OBP', 'fans_OBP')], 1,
                    function(x) sd(x, na.rm=T))
bat$agg.sd.ops <- apply(bat[,c('fans_OPS', 'steamer_OPS', 'fans_OPS')], 1,
                    function(x) sd(x, na.rm=T))

##Pitching stats
pit$agg.sd.w <- apply(pit[,c('fans_W', 'steamer_W', 'zips_W')], 1, function(x) 
                    sd(x, na.rm=T))
#zips doesn't forecast saves
pit$agg.sd.sv <- apply(pit[,c('fans_SV', 'steamer_SV')], 1, function(x) sd(x, na.rm=T))
pit$agg.sd.k <- apply(pit[,c('fans_SO', 'steamer_SO', 'zips_SO')], 1, function(x) 
                    sd(x, na.rm=T))
pit$agg.sd.era <- apply(pit[,c('fans_ERA', 'steamer_ERA', 'zips_ERA')], 1, 
                     function(x) sd(x, na.rm=T))
pit$agg.sd.whip <- apply(pit[,c('fans_WHIP', 'steamer_WHIP', 'zips_WHIP')], 1,
                      function(x) sd(x, na.rm=T))

bat$agg.pa <- apply(bat[,c('fans_PA', 'steamer_PA', 'zips_PA')], 1,
                    function(x) mean(x, na.rm=T))
pit$agg.ip <- apply(pit[,c('fans_IP', 'steamer_IP', 'zips_IP')], 1, 
                     function(x) mean(x, na.rm=T))
bat$agg.sd.pa <- apply(bat[,c('fans_PA', 'steamer_PA', 'zips_PA')], 1,
                    function(x) sd(x, na.rm=T))
pit$agg.sd.ip <- apply(pit[,c('fans_IP', 'steamer_IP', 'zips_IP')], 1, 
                     function(x) sd(x, na.rm=T))
bat$agg.pa[bat$agg.pa == 1] <- NA
bat$pa.weight <- bat$agg.pa/mean(bat$agg.pa, na.rm=T)
pit$agg.ip[pit$agg.ip == 1] <- NA
pit$ip.weight <- pit$agg.ip/mean(pit$agg.ip, na.rm=T)

#we're going to only focus on the people who are predicted to score more than one
#run.  This does away with quite a few problems
bat <- bat[bat$agg.runs > 0,]
bat$agg.runs.std <- scale(bat$agg.runs)
bat$agg.hr.std <- scale(bat$agg.hr)
bat$agg.rbi.std <- scale(bat$agg.rbi)
bat$agg.sb[bat$agg.sb==0] <- .5
log.sb <- log(bat$agg.sb)
bat$agg.sb.std <- scale(log.sb) # log it because the skew is severe
bat$agg.obp.std <- scale(bat$agg.obp)
bat$agg.w.obp.std <- scale(bat$agg.obp*bat$pa.weight)

bat$talent.index <- bat$agg.runs.std + bat$agg.hr.std + bat$agg.rbi.std + bat$agg.sb.std + bat$agg.w.obp.std

#only look at those with more than one strikeout
pit <- pit[pit$agg.k > 1,]
pit$agg.w[pit$agg.w==0] <- .5
log.w <- log(pit$agg.w)
pit$agg.w.std <- scale(log.w)
pit$agg.sv.std <- NA
pit$agg.sv.std[which(pit$agg.sv > 0)] <- scale(pit$agg.sv[which(pit$agg.sv > 0)])
#logged because of the skew
pit$agg.k.std <- scale(log(pit$agg.k))
pit$agg.era.std <- scale(pit$agg.era)*-1
pit$agg.whip.std <- scale(pit$agg.whip)*-1
pit$agg.w.era.std <- scale(pit$agg.era/pit$ip.weight)*-1
pit$agg.w.whip.std <- scale(pit$agg.whip/pit$ip.weight)*-1

pit$talent.index <- rowSums(pit[,c(72:74, 77,78)], na.rm=T)

pit.length <- length(pit$fans_Name)
bat.length <- length(bat$fans_Name)

combined <- data.frame(name=c(as.character(pit$fans_Name), as.character(bat$fans_Name)),
                        perf.index=c(scale(pit$talent.index), scale(bat$talent.index)),
                        std.w=c(pit$agg.w.std, rep(NA, bat.length)),
                        std.sv=c(pit$agg.sv.std, rep(NA, bat.length)),
                        std.k=c(pit$agg.k.std, rep(NA, bat.length)),
                        std.w.era=c(pit$agg.w.era.std, rep(NA, bat.length)),
                        std.w.whip=c(pit$agg.w.whip.std, rep(NA, bat.length)),
                        std.era=c(pit$agg.era.std, rep(NA, bat.length)),
                        std.whip=c(pit$agg.whip.std, rep(NA, bat.length)),
                        std.r=c(rep(NA, pit.length), bat$agg.runs.std),
                        std.hr=c(rep(NA, pit.length), bat$agg.hr.std),
                        std.rbi=c(rep(NA, pit.length), bat$agg.rbi.std),
                        std.sb=c(rep(NA, pit.length), bat$agg.sb.std),
                        std.obp=c(rep(NA, pit.length), bat$agg.obp.std),
                        std.w.obp=c(rep(NA, pit.length), bat$agg.w.obp.std),
                        ip=c(pit$agg.ip, rep(NA, bat.length)),
                        w=c(pit$agg.w, rep(NA, bat.length)),
                        sv=c(pit$agg.sv, rep(NA, bat.length)),
                        k=c(pit$agg.k, rep(NA, bat.length)),
                        era=c(pit$agg.era, rep(NA, bat.length)),
                        whip=c(pit$agg.whip, rep(NA, bat.length)),
                        pa=c(rep(NA, pit.length), bat$agg.pa),
                        r=c(rep(NA, pit.length), bat$agg.runs),
                        hr=c(rep(NA, pit.length), bat$agg.hr),
                        rbi=c(rep(NA, pit.length), bat$agg.rbi),
                        sb=c(rep(NA, pit.length), bat$agg.sb),
                        obp=c(rep(NA, pit.length), bat$agg.obp),
                        w.obp=c(rep(NA, pit.length), bat$agg.w.obp)
                        )

library(rvest)
library(magittr)
library(stringr)
library(car)

url <- html('http://fantasynews.cbssports.com/fantasybaseball/rankings/h2h/overall/yearly')
pos <- url %>% 
  html_nodes('td:nth-child(1) td+ td') %>% 
  html_text()

POS <- str_extract(pos, "\\(\\w{1,2}\\)")
name <- str_extract(pos, perl(".*(?=\\s.{1,3}\\()"))
POS <- gsub('\\(', '', POS)
POS <- gsub('\\)', '', POS)

df.id <- data.frame(name = name,
                    position = as.factor(POS))

df.id$position <- recode(df.id$position, "c('LF', 'RF', 'CF')='OF'")

df <- full_join(df.id, combined)

df.pit <- subset(df, df$position=='SP' | df$position=='RP')
df.bat <- df[-grep('.P', df$position), ]
rownames(df.pit) <- 1:nrow(df.pit)
rownames(df.bat) <- 1:nrow(df.bat)

df.pit<-arrange(df.pit, desc(perf.index))

```

I play fantasy baseball.  In some ways, I'm embarrassed to admit it.  I recall being teased for this on more than one occassion when I first started playing these games over 10 years ago.  However, I think I'm in good company today.  The Fantasy Sports Trade Association (FSTA) has estimated the number of individuals playing fantasy sports in the US and Canada at [over 41 million][ref1].  While I'm not confident that the FSTA is an unbiased party, I think that the figure is in the general ballpark of being correct.  

Regardless, I'm through defending myself.  A couple of weeks ago, I drafted my players for my two teams.  In doing so, I spent some time trying to create my own projections for how individual players were going to do.  There are a variety of ways to obtain predictions for how individual players will do for the upcoming season.  The website [Fangraphs][ref2] includes a handy feature which allows you to download csv files of their projections.  They include projections from the ZIPS, and STEAMER projection systems, as well as projections collected from site users who choose to offer up predictions for players.

As Nate Silver famously [demonstrated][ref3], taking an aggregate of multiple predictions is much better than looking at any individual one.  Thus, I attempted to create a projection from a relatively simple combination of these projections.

In some ways, it worked out pretty well.  Here are the top pitchers spat out by my system, the index I used to rank them (higher is better) and their predicted stats.

```{r}
df.pit[1:20,c(1:3, 17:22)]
```

This seems about right.  However, to find the top reliever, we need to go way down to number 58.


```{r}
df.pit[50:60, c(1:3, 17:22)]
```

How did this happen?  Well, first let me say what the ranking logic is:


$$
  PI = Z_win + Z_save + Z_log(k) + Z_w.era + Z_w.whip
$$

Where $PI$ is the performance index, and each term represents the standardized value of the average prediction from each projection system.  $w.era$ and $w.whip$ are weighted by the ratio of $predicted innings/\mu_predicted innings$.

I should say that after the above calculations, I also standardized $PI$.

Just to illustrate the problem a bit better, here's the distribution for the two pitcher types:

```{r}
library(ggplot2)
ggplot(df.pit, aes(x=perf.index, fill = position, group = position)) + 
  geom_density(alpha = .5) + 
  scale_fill_manual(values = c('#144256', '#88301B')) + 
  theme_bw()
```

We can do the same for all the values which make up the index:

```{r}
library(ggplot2)
ggplot(df.pit, aes(x=std.w, fill = position, group = position)) + 
  geom_density(alpha = .5) + 
  scale_fill_manual(values = c('#144256', '#88301B')) + 
  theme_bw() + 
  ggtitle('Wins')

ggplot(df.pit, aes(x=std.sv, fill = position, group = position)) + 
  geom_density(alpha = .5) + 
  scale_fill_manual(values = c('#144256', '#88301B')) + 
  theme_bw() + 
  ggtitle('Saves')

ggplot(df.pit, aes(x=std.k, fill = position, group = position)) + 
  geom_density(alpha = .5) + 
  scale_fill_manual(values = c('#144256', '#88301B')) + 
  theme_bw() + 
  ggtitle('Strikeouts')

ggplot(df.pit, aes(x=std.w.era, fill = position, group = position)) + 
  geom_density(alpha = .5) + 
  scale_fill_manual(values = c('#144256', '#88301B')) + 
  theme_bw() + 
  ggtitle('Weighted ERA')

ggplot(df.pit, aes(x=std.w.whip, fill = position, group = position)) + 
  geom_density(alpha = .5) + 
  scale_fill_manual(values = c('#144256', '#88301B')) + 
  theme_bw() + 
  ggtitle('Weighted WHIP')
```

What really struck me about all of this is that these plots don't really shout out as anything being wrong.  I mean, they look exactly how I might expect them to look!  Starters have more wins and strikeouts simply by virtue of pitching more innings.  Similarly, relievers are the only ones who earn points for saves.  Maybe the innings weighting is not a fair adjustment, but I tend to believe that relievers just aren't as useful, since they can't contribute to wins and strikeouts like a starter can.

It seems to do a pretty good job for hitters too:

```{r}
df.pit$w[df.pit$w==0] <- .5
log.w <- log(df.pit$w)
df.pit$std.w <- scale(log.w)
df.pit$sv[df.pit$sv==0] <- .5
log.sv <- log(df.pit$sv)
df.pit$std.sv <- scale(log.sv)
#[which(df.pit$sv > 0)] <- scale(df.pit$sv[which(df.pit$sv > 0)])
#logged because of the skew
df.pit$std.k <- scale(log(df.pit$k))
df.pit$std.era <- scale(df.pit$era)*-1
df.pit$std.whip <- scale(df.pit$whip)*-1
df.pit$ip.weight <- df.pit$ip/mean(df.pit$ip, na.rm=T)
df.pit$std.w.era <- scale(df.pit$era/df.pit$ip.weight)*-1
df.pit$std.w.whip <- scale(df.pit$whip*-1)/df.pit$ip.weight

df.pit$perf.index <- rowSums(df.pit[,c(4:8)], na.rm=T)

df.pit<-arrange(df.pit, desc(perf.index))

df.bat[1:20, c(1:3, 21:26)]
```

However, I had a real bear of a time combining these indices.  Normally I would standardize the two performance indices and then combine.  However, these indices already *are* standardized, and we're seeing somewhat different scales.  The reason?

Neither one is really as normally distributed as it should be.

```{r}
library(ggplot2)

ggplot(df.pit, aes(x=perf.index)) +  
  geom_histogram(binwidth=.05, fill='#144256') + 
  theme_bw() + ylab('Count') + xlab('Performance index') + 
  ggtitle('Pitchers')

ggplot(df.bat, aes(x=perf.index)) +  
  geom_histogram(binwidth=.2, fill='#144256') + 
  theme_bw() + ylab('Count') + xlab('Performance index') + 
  ggtitle('Batters')
```


After downloading the relevant data, I've got six csv files with the projected stats for each player for the upcoming season from each of the projection systems - one file each for pitchers and batters.  

With this data, I can examine the projections for the categories I'm interested in.  I'm enrolled in two leagues, and each use a slightly different scoring system.  Here are the scoring categories I'm interested in.

**Batters:**  R, HR, RBI, SB, OBP, 1B, 2B, 3B, BB, AVG, OBP, OPS

**Pitchers:** W, CG, SHO, SV, K, GIDP, HLD, ERA, WHIP, PICK

Some of these pitching metrics aren't available from the projections.  In particular, I'm not going to be able to forecast CG, SHO, GIDP, HLD, or PICKs.  This is a clear shortcoming, but one I'll have to accept.

Regardless, in order to create an index of achievement in each of these categories (and to keep them comparable), I'm going to use standardized scores.  First, we'll create two large tables - one each for pitchers and batters with the projections from each of the three sources.

```{r}

```

Now, we can take the average of the projections for the categories of interest.

```{r}


```

I'm also going to get the standard deviation of each category, across the three sources.  I wont use it immediately, but I'm sure I'll do something with it eventually.

*Note to self - look at variability across projections for players who might be bigger risks*

```{r}
##Batting stats

```

There's one more thing to consider before I try to make some kind of an index.  Specifically, some of these categories are not simple 'counting statistics'.  That is, two batters could have the same batting average for a given week, but if one batter has 25 plate-appearances, and the second has only 5, then the batting average from the former will carry more weight than the former.  The same is true for pitchers and their ERA and WHIP.  In order to account for this, I'm going to adjust the relevant statistics for each batter by weighting them according to $x_observed/\bar{x}$, where $x$ = plate appearances and innings pitched for batters and pitchers, respectively.

```{r}
#Below is for fantasy fellowship

```

Now, I need to get some more information from the web.  Let's start by getting the position of each player

```{r}


write.table(df, file='projections.csv', sep = ',')
write.table(data, file='data.csv', sep=',')
write.table(names, file='names.csv', sep=',')
pitchers <- df %>%
  filter(position == 'RP' | position == 'SP')
write.table(pitchers, file='pitchers.csv', sep=',')
batters <- df %>%
  filter(position != 'RP' | position!= 'SP')
write.table(batters, file='batters.csv', sep=',')
```


```{r}
## these balls

bat$agg.runs.std <- scale(bat$agg.runs)
bat$agg.1b.std <- scale(bat$agg.1b)
bat$agg.2b.std <- scale(bat$agg.2b)
bat$agg.3b.std <- scale(bat$agg.3b)
bat$agg.hr.std <- scale(bat$agg.hr)
bat$agg.rbi.std <- scale(bat$agg.rbi)
bat$agg.sb.std <- scale(bat$agg.sb)
bat$agg.bb.std <- scale(bat$agg.bb)
bat$agg.avg.std <- scale(bat$agg.avg)
bat$agg.ops.std <- scale(bat$agg.ops)
bat$agg.w.avg.std <- scale(bat$agg.avg*bat$pa.weight)
bat$agg.w.ops.std <- scale(bat$agg.ops*bat$pa.weight)

bat$talent.index <- bat$agg.runs.std + bat$agg.1b.std + bat$agg.2b.std + 
  bat$agg.3b.std + bat$agg.hr.std + bat$agg.rbi.std + bat$agg.bb.std + 
  bat$agg.sb.std + bat$agg.w.avg.std + bat$agg.w.ops.std

collapsed.bat <- data.frame(name=as.character(bat$fans_Name),
                        perf.index=bat$talent.index)
sorted<-arrange(collapsed.bat, desc(perf.index))

pit$agg.w.std <- scale(pit$agg.w)
pit$agg.sv.std <- scale(pit$agg.sv)
pit$agg.k.std <- scale(pit$agg.k)
pit$agg.era.std <- scale(pit$agg.era)*-1
pit$agg.whip.std <- scale(pit$agg.whip)*-1
pit$agg.w.era.std <- scale(pit$agg.era/pit$ip.weight)*-1
pit$agg.w.whip.std <- scale(pit$agg.whip/pit$ip.weight)*-1

pit$talent.index <- pit$agg.w.std + pit$agg.sv.std + pit$agg.k.std + pit$agg.w.era.std + pit$agg.w.whip.std

collapsed <- data.frame(name=c(as.character(pit$fans_Name), as.character(bat$fans_Name)),
                        perf.index=c(pit$talent.index, bat$talent.index))
sorted<-arrange(collapsed, desc(perf.index))

```



Okay, items 72354 and 43760.  We can remove those without too much difficulty.  Let's just double check that we wont do too much damage by removing all carb and fat entires with those values.

```{r}
df[which(df$Menu_Item_ID == 43760),]
df[which(df$Menu_Item_ID == 72354),]
```

Checks out okay - the other years are all NA anyway.  Let's remove and refit the model



[ref1]:  <http://www.fsta.org/?page=Demographics>
[ref2]:  <http://www.fangraphs.com>
[ref3]:  <http://en.wikipedia.org/wiki/FiveThirtyEight#2012_U.S._elections>