---
title: "Shameless Baseball Love"
output: html_document
---

I play fantasy baseball.  In some ways, I'm embarrassed to admit it.  I recall being teased for this on more than one occassion when I first started playing these games over 10 years ago.  However, I think I'm in good company today.  The Fantasy Sports Trade Association (FSTA) has estimated the number of individuals playing fantasy sports in the US and Canada at [over 41 million][ref1].  While I'm not confident that the FSTA is an unbiased party, I think that the figure is in the general ballpark of being correct.  

Regardless, I'm through defending myself.  I need to figure out how I'm going to draft my players!  There are a variety of ways to obtain predictions for how individual players will do for the upcoming season.  The website [Fangraphs][ref2] includes a handy feature which allows you to download csv files of their projections.  They include projections from the ZIPS, and STEAMER projection systems, as well as projections collected from site users who choose to offer up predictions for players.

As Nate Silver famously [demonstrated][ref3], taking an aggregate of multiple predictions is much better than looking at any individual one.  Thus, I'm going to create a projection from a relatively simple combination of these projections.

After downloading the relevant data, I've got six csv files with the projected stats for each player for the upcoming season from each of the projection systems - one file each for pitchers and batters.  

```{r, warning=FALSE}
fans.bat <- read.csv('../../../Data/Fans_batters.csv')
steamer.bat <- read.csv('../../../Data//Steamer_batters.csv')
zips.bat <- read.csv('../../../Data/ZIPS_batters.csv')
fans.pit <- read.csv('../../../Data//Fans_pitchers.csv')
steamer.pit <- read.csv('../../../Data/Steamer_pitchers.csv')
zips.pit <- read.csv('../../../Data/ZIPS_pitchers.csv')
```

With this data, I can examine the projections for the categories I'm interested in.  I'm enrolled in two leagues, and each use a slightly different scoring system.  Here are the scoring categories I'm interested in.

**Batters:**  R, HR, RBI, SB, OBP, 1B, 2B, 3B, BB, AVG, OBP, OPS

**Pitchers:** W, CG, SHO, SV, K, GIDP, HLD, ERA, WHIP, PICK

Some of these pitching metrics aren't available from the projections.  In particular, I'm not going to be able to forecast CG, SHO, GIDP, HLD, or PICKs.  This is a clear shortcoming, but one I'll have to accept.

Regardless, in order to create an index of achievement in each of these categories (and to keep them comparable), I'm going to use standardized scores.  First, we'll create two large tables - one each for pitchers and batters with the projections from each of the three sources.

```{r}
library(dplyr)
#Rename variables so I know where they come from
names(fans.bat)[1:24] <- paste('fans', names(fans.bat)[1:24], sep='_')
names(steamer.bat)[1:29] <- paste('steamer', names(steamer.bat)[1:29],
                                  sep='_')
names(zips.bat)[1:24] <- paste('zips', names(zips.bat)[1:24], sep='_')
#join by player id
bat <- full_join(fans.bat, steamer.bat, by='playerid')
bat <- full_join(bat, zips.bat, by='playerid')

#repeat for pitching
names(fans.pit)[1:19] <- paste('fans', names(fans.pit)[1:19], sep='_')
names(steamer.pit)[1:20] <- paste('steamer', names(steamer.pit)[1:20],
                                  sep='_')
names(zips.pit)[1:18] <- paste('zips', names(zips.pit)[1:18], sep='_')
#join by player id
pit <- full_join(fans.pit, steamer.pit, by='playerid')
pit <- full_join(pit, zips.pit, by='playerid')
```

Now, we can take the average of the projections for the categories of interest.

```{r}
##Batting stats
bat$agg.runs <- apply(bat[,c('fans_R', 'steamer_R', 'fans_R')], 1,
                    function(x) mean(x))
bat$agg.hr <- apply(bat[,c('fans_HR', 'steamer_HR', 'fans_HR')], 1,
                    function(x) mean(x))
bat$agg.rbi <- apply(bat[,c('fans_RBI', 'steamer_RBI', 'fans_RBI')], 1,
                    function(x) mean(x))
bat$agg.sb <- apply(bat[,c('fans_SB', 'steamer_SB', 'fans_SB')], 1,
                    function(x) mean(x))
bat$agg.obp <- apply(bat[,c('fans_OBP', 'steamer_OBP', 'fans_OBP')], 1,
                    function(x) mean(x))
#Singles are a bit trickier...
bat$fans_1b <- bat$fans_H - (bat$fans_X2B + bat$fans_X3B + bat$fans_HR)
bat$steamer_1b <- bat$steamer_H - (bat$steamer_X2B + bat$steamer_X3B +
                                     bat$steamer_HR)
bat$zips_1b <- bat$zips_H - (bat$zips_X2B + bat$zips_X3B + bat$zips_HR)
bat$agg.1b <- apply(bat[,c('fans_1b', 'steamer_1b', 'fans_1b')], 1,
                    function(x) mean(x))
bat$agg.2b <- apply(bat[,c('fans_X2B', 'steamer_X2B', 'fans_X2B')], 1, 
                    function(x) mean(x))
bat$agg.3b <- apply(bat[,c('fans_X3B', 'steamer_X3B', 'fans_X3B')], 1,
                    function(x) mean(x))
bat$agg.bb <- apply(bat[,c('fans_BB', 'steamer_BB', 'fans_BB')], 1,
                    function(x) mean(x))
bat$agg.avg <- apply(bat[,c('fans_AVG', 'steamer_AVG', 'fans_AVG')], 1,
                    function(x) mean(x))
bat$agg.obp <- apply(bat[,c('fans_OBP', 'steamer_OBP', 'fans_OBP')], 1,
                    function(x) mean(x))
bat$agg.ops <- apply(bat[,c('fans_OPS', 'steamer_OPS', 'fans_OPS')], 1,
                    function(x) mean(x))

##Pitching stats
pit$agg.w <- apply(pit[,c('fans_W', 'steamer_W', 'zips_W')], 1, function(x) 
                    mean(x))
#zips doesn't forecast saves
pit$agg.sv <- apply(pit[,c('fans_SV', 'steamer_SV')], 1, function(x) mean(x))
pit$agg.k <- apply(pit[,c('fans_SO', 'steamer_SO', 'zips_SO')], 1, function(x) 
                    mean(x))
pit$agg.era <- apply(pit[,c('fans_ERA', 'steamer_ERA', 'zips_ERA')], 1, 
                     function(x) mean(x))
pit$agg.whip <- apply(pit[,c('fans_WHIP', 'steamer_WHIP', 'zips_WHIP')], 1,
                      function(x) mean(x))
```


*Note to self - look at variability across projections for players who might be bigger risks*

```{r}
##Batting stats
bat$agg.sd..runs <- apply(bat[,c('fans_R', 'steamer_R', 'fans_R')], 1,
                    function(x) sd(x))
bat$agg.sd.hr <- apply(bat[,c('fans_HR', 'steamer_HR', 'fans_HR')], 1,
                    function(x) sd(x))
bat$agg.sd.rbi <- apply(bat[,c('fans_RBI', 'steamer_RBI', 'fans_RBI')], 1,
                    function(x) sd(x))
bat$agg.sd.sb <- apply(bat[,c('fans_SB', 'steamer_SB', 'fans_SB')], 1,
                    function(x) sd(x))
bat$agg.sd.obp <- apply(bat[,c('fans_OBP', 'steamer_OBP', 'fans_OBP')], 1,
                    function(x) sd(x))
#Singles are a bit trickier...
bat$fans_1b <- bat$fans_H - (bat$fans_X2B + bat$fans_X3B + bat$fans_HR)
bat$steamer_1b <- bat$steamer_H - (bat$steamer_X2B + bat$steamer_X3B +
                                     bat$steamer_HR)
bat$zips_1b <- bat$zips_H - (bat$zips_X2B + bat$zips_X3B + bat$zips_HR)
bat$agg.sd.1b <- apply(bat[,c('fans_1b', 'steamer_1b', 'fans_1b')], 1,
                    function(x) sd(x))
bat$agg.sd.2b <- apply(bat[,c('fans_X2B', 'steamer_X2B', 'fans_X2B')], 1, 
                    function(x) sd(x))
bat$agg.sd.3b <- apply(bat[,c('fans_X3B', 'steamer_X3B', 'fans_X3B')], 1,
                    function(x) sd(x))
bat$agg.sd.bb <- apply(bat[,c('fans_BB', 'steamer_BB', 'fans_BB')], 1,
                    function(x) sd(x))
bat$agg.sd.avg <- apply(bat[,c('fans_AVG', 'steamer_AVG', 'fans_AVG')], 1,
                    function(x) sd(x))
bat$agg.sd.obp <- apply(bat[,c('fans_OBP', 'steamer_OBP', 'fans_OBP')], 1,
                    function(x) sd(x))
bat$agg.sd.ops <- apply(bat[,c('fans_OPS', 'steamer_OPS', 'fans_OPS')], 1,
                    function(x) sd(x))

##Pitching stats
pit$agg.sd.w <- apply(pit[,c('fans_W', 'steamer_W', 'zips_W')], 1, function(x) 
                    sd(x))
#zips doesn't forecast saves
pit$agg.sd.sv <- apply(pit[,c('fans_SV', 'steamer_SV')], 1, function(x) sd(x))
pit$agg.sd.k <- apply(pit[,c('fans_SO', 'steamer_SO', 'zips_SO')], 1, function(x) 
                    sd(x))
pit$agg.sd.era <- apply(pit[,c('fans_ERA', 'steamer_ERA', 'zips_ERA')], 1, 
                     function(x) sd(x))
pit$agg.sd.whip <- apply(pit[,c('fans_WHIP', 'steamer_WHIP', 'zips_WHIP')], 1,
                      function(x) sd(x))
```

This doesn't look like anything too fishy.  I'm guessing that the huge effect of carbs in Godfather's is being driven by the outlier way out ~175 carbs and 125 calories.  Ditto for Round Table being driven by the outlier out near 150 grams of fat.  Interestingly, the plot for carbohydrates seems to have two distinct groups in both chains, but it is esspecially pronounced for Round Table.  Note all the data points clustered together in a line that is below the larger cluster.  It looks like if we define a line that runs through the origin and the point (x=50, y=250), we can just grab the values which are below that for a sense of what these items are.  Let's give that a shot.

```{r}
df.pizza$line <- 5*df.pizza$Carbohydratesg
ggplot(df.pizza, aes(x=Carbohydratesg, y=Calories)) +
  geom_point(color='#88301B') + facet_wrap(~Restaurant) + 
  geom_line(aes(x=Carbohydratesg, y=line), color='#144256')+
  theme_bw()
```

That looks okay.  Let's get everything smaller than the values in that line.

```{r}
df.pizza[sample(which(df.pizza$Calories < df.pizza$line), 20),c(1, 3, 11, 12, 18, 21)]
```

Ah.  Basically, this is soda, which is typically made up of nothing but carbohydrates.

Okay, let's remove the two crazy outliers and see about refitting the model.

```{r}
library(dplyr)
df %>%
  filter(TotalFatg>125) %>%
  filter(Restaurant == "Round Table Pizza")
df %>%
  filter(Carbohydratesg>150) %>%
  filter(Restaurant == "Godfather's Pizza")
```

Okay, items 72354 and 43760.  We can remove those without too much difficulty.  Let's just double check that we wont do too much damage by removing all carb and fat entires with those values.

```{r}
df[which(df$Menu_Item_ID == 43760),]
df[which(df$Menu_Item_ID == 72354),]
```

Checks out okay - the other years are all NA anyway.  Let's remove and refit the model



[ref1]:  <http://www.fsta.org/?page=Demographics>
[ref2]:  <http://www.fangraphs.com>
[ref3]:  <http://en.wikipedia.org/wiki/FiveThirtyEight#2012_U.S._elections>