---
title: "Menustat"
output: html_document
---

I recently found a pretty interesting dataset I thought I'd examine a little bit.  I took the following data from [menustat.org][ref1].  You can easily download the same data by using their 'search' function, and having it return all data for all available years.  Once done, there's a button that lets you export the data as a csv.  

```{r, eval=FALSE}
menus<-read.csv('../Data/menustat-546cf6b433804.csv')
#this doesn't work.  Throws an error:

#Error in read.table(file = file, header = header, sep = sep, quote = quote,  : 
#  more columns than column names
```

Aw damn.  Well, that didn't work.  Why not?  The error message says that there's a mismatch between the number of columns, and the number of names it has for the columns.  Usually, this function reads the column names from the first line of the csv document, so I'm guessing that something is wrong with the first line of the csv.  Opening it up in a text editor shows the following:

![Raw text of menustat][img1]

See the big chunk of text next to the 1 on the lefthand side?  That's all the stuff that appears in the first line, and we can see that it's just kind of a description of the file.  We can get rid of that.  Line 2 seems to have the columns we want.  While we're at it, we can also see that there's a bunch of empty cells that look like this:  "   -".  When we read this into r, it will be represented as '\t-'.  There are also some spots where there's a tab without the dash (i.e. '  ').  We're gonna get rid of those too.  So we're going to take a slightly different approach from just reading in the csv:

1.  Read the file, line by line as one big vector
2.  Remove the first line.
3.  Replace any '  -' or '  ' with a simple blank cell.
3.  Turn the vector into a dataframe.


```{r}
menus<-readLines('../Data/menustat-546cf6b433804.csv')
menus<-menus[-1]
menus<-gsub('\t-', '', menus)
menus<-gsub('\t', '', menus)
menus<-read.csv(textConnection(menus)) #this takes a minute...
```

Now we have a datafile for our menus data!  Let's get some information about it:

```{r}
dim(menus)
```

We've got 60,238 observations across 52 different variables.  Let's get a little information about those variables.

```{r}
str(menus)
```

We can now see the names for our variables.  Looks like there's one for restaurant, one for food category, one for the item, and then we have a bunch of variables which are repeated for each of 3 years: 2014, 2013, 2012.  These variables describe the item, give us a serving size, and then the nutrient information (e.g. calories, fat, carbs, protein, etc.).  We can also see that everything, with a couple of exceptions, is stored as a factor, which isn't ideal.  Let's replace some of these things with characters:

```{r}
submenus<-menus[,3:51] #leave 'Restuarant', 'Food Category', and 'Menu Item ID' untouched.
submenus[]<-lapply(submenus, as.character)
menus[,3:51]<-submenus
```

Now, in order to do any serious quantitative analyses, we should convert these characters to numeric variables.  Unfortunately, because of the way the data is represented, there are lots of values which say something like '25-30' (e.g. for total fat in a serving) or '<1'.  When we convert these variables, these observations will be lost.  We could take some steps to preserve them, but it isn't clear what such values should be replaced by, so we'll just leave them as NA.

```{r}
submenus<-menus[,c(7:15, 19:51)]
submenus[]<-lapply(submenus, as.numeric)
menus[,c(7:15, 19:51)]<-submenus
```

The next thing I'd like to do is reshape this data a bit.  Right now, we've got three years of observations for each menu item, and each year is on the same row (we have multiple variables that are measured for each year as well).  I'd like to have this rearranged such that there's one row for each year.  Also known as 'tidy data' So:

```{r}
library(reshape2)
library(stringr)
library(plyr)
df<-melt(menus, id.vars = c('Restaurant.', 'Food.Category.', 'Item_Name.', 
                           'Menu_Item_ID'))
df$year<-str_match(df$variable, "[0-9]{4}")
df$variable <- gsub('\\.{1,2}', '', df$variable)#remove dots
df$variable <- gsub('[0-9]', '', df$variable)#remove year
df$variable <- gsub('\\s+$', '', df$variable)#remove trailing space
df<-dcast(df, Restaurant. + Food.Category. + Item_Name. + Menu_Item_ID + year ~ 
           variable , value.var = 'value')
df<-arrange(df, Restaurant., Item_Name.)
```

That's much better.  Now, let's make a couple of preliminary plots.  I'm first going to focus on calories plus the macronutrients - carbs, proteins, and fats.  Let's look at how these things vary depending on which food category they fall into.

```{r}
library(ggplot2)
library(dplyr)
df$Calories <- as.numeric(df$Calories)
ordered.df <- group_by(df, Food.Category.) %>%
  summarise(med = median(Calories, na.rm=T)) %>%
  arrange(desc(med)) %>%
  as_data_frame()
df$Food.Category. <- factor(df$Food.Category., levels=ordered.df$Food.Category.)

plot <- ggplot(df, aes(x=Food.Category., y=Calories))
plot + geom_boxplot(fill='#ABC3CE') +
  xlab('Food Category') + 
  theme_bw() + 
  theme(axis.text.x = element_text(angle=15, vjust=.9))
```

I've also taken the liberty of ordering the x axis according to median, descending from left to right.  Nothing especially surprising here.  Biggest calorie bombs are Burgers, Entrees, and Sandwiches.  One Burger tips the scales at around 5000 calories, and while that's around 2 days worth of the recommended daily energy needs for the average male, I guess it isn't *too* surprising.  Next up is carbs:

```{r}
df$Carbohydratesg <- as.numeric(df$Carbohydratesg)
ordered.df <- group_by(df, Food.Category.) %>%
  summarise(med = median(Carbohydratesg, na.rm=T)) %>%
  arrange(desc(med)) %>%
  as_data_frame()
df$Food.Category. <- factor(df$Food.Category., levels=ordered.df$Food.Category.)


plot <- ggplot(df, aes(x=Food.Category., y=Carbohydratesg))
plot + geom_boxplot(fill='#ABC3CE') +
  xlab('Food Category') + ylab('Carbohydrates') + 
  theme_bw() + 
  theme(axis.text.x = element_text(angle=15, vjust=.9))
```

This is a bit odd.  There's apparently a side or appetizer which has north of 800 grams of carbohydrates.  I find this hard to believe.  Let's look a little more closely.

```{r}
subset(df, df$Carbohydratesg > 800)
```

Ah!  My old alma mater!  I spent about 7 months employed by Red Robin in the year between undergrad and my master's program at SFSU.  It let me pay off the absurd costs incurred by applying to graduate school in my first attempt.  Anyway, this seems to say that there are 838 grams of carbohydrates in 313 calories worth of Guac & Salsa with chips.  I don't know that I believe this.  Let's look at the rows around it (where the same item for 2013 and 2012 should appear)

```{r}
df[131161:131163,]
```

Well, 2013 seems to be about as expected.  2014, however, seems to be a lost cause.  I even did a bit of poking around on the web to see if I could find some better information, but there doesn't seem to be anything on the first page or two of google.  We'll replace these carb count here with NA and replot.

```{r}
df$Carbohydratesg[131161] <- NA
plot <- ggplot(df, aes(x=Food.Category., y=Carbohydratesg))
plot + geom_boxplot(fill='#ABC3CE') +
  xlab('Food Category') + ylab('Carbohydrates') + 
  theme_bw() +
  theme(axis.text.x = element_text(angle=15, vjust=.9))
```

That's much better.  On to protein:

```{r}
df$Proteing <- as.numeric(df$Proteing)
ordered.df <- group_by(df, Food.Category.) %>%
  summarise(med = median(Proteing, na.rm=T)) %>%
  arrange(desc(med)) %>%
  as_data_frame()
df$Food.Category. <- factor(df$Food.Category., levels=ordered.df$Food.Category.)


plot <- ggplot(df, aes(x=Food.Category., y=Proteing))
plot + geom_boxplot(fill='#ABC3CE') +
  xlab('Food Category') + ylab('Protein') + 
  theme_bw() +
  theme(axis.text.x = element_text(angle=15, vjust=.9))
```

Okay, a few oddities.  A couple of `Toppings & Ingredients' with quite a bit more protein than one would think.  Also, there's a burger with over 300 grams of protein.  I'll bet it's the one with 5000 calories.

```{r}
subset(df, df$Proteing > 240)
```

Okay, first of all, behold the [Landfill Burger][ref1].  Yikes.  That is the definition of an outlier.  Still, I see no reason to remove it or anything.  That's a real thing.  A real burger.

Moving on, we see the sides of Blue Cheese and Ranch dressing.  Popular among body builders as a quick dose of protein immediately following a workout...

Except not at all.  We can attempt the same thing

***LEFT OFF HERE***

```{r}
df$TotalFatg <- as.numeric(df$TtotalFatg)
ordered.df <- group_by(df, Food.Category.) %>%
  summarise(med = median(TotalFatg, na.rm=T)) %>%
  arrange(desc(med)) %>%
  as_data_frame()
df$Food.Category. <- factor(df$Food.Category., levels=ordered.df$Food.Category.)


plot <- ggplot(df, aes(x=Food.Category., y=TotalFatg))
plot + geom_boxplot(fill='#ABC3CE') +
  xlab('Food Category') + ylab('Total Fat') + 
  theme_bw()
```

[img1]: <menustat_text.png>
[ref1]:  <http://api.ning.com/files/drL7ji10lw0df0UGzfzR3Wgna8ZmVV2JSf-ebXK3ggx1hTZlYsoH5*nmXIW9-QjqmRicEjoeROQZ4I*FS3FQKPxRpAZuKxwx/100_0218.JPG?width=737&height=552>