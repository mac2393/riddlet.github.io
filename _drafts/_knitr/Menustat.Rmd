---
title: "Plot and clean"
output: html_document
---

In a [previous post][ref1], I described a dataset taken from [menustat.org][ref2].  I used the dataset to illustrate how some minor tweaks can get your analyses to run much more quickly.

Anyway, the data is interesting in its own right, so I thought I'd look at some of what's in it here.

```{r, cache=TRUE, cache.lazy=TRUE, echo=FALSE, warning=FALSE}
menus<-readLines('../Data/menustat-546cf6b433804.csv')
menus<-menus[-1]
menus<-gsub('\t-', '', menus)
menus<-gsub('\t', '', menus)
menus<-read.csv(textConnection(menus)) #this takes a minute...
submenus<-menus[,3:51] #leave 'Restuarant', 'Food Category', and 'Menu Item ID' untouched.
submenus[]<-lapply(submenus, as.character)
menus[,3:51]<-submenus

submenus<-menus[,c(7:15, 19:51)]
submenus[]<-lapply(submenus, as.numeric)
menus[,c(7:15, 19:51)]<-submenus

library(reshape2)
library(stringr)
library(plyr)
df <- melt(menus, id.vars = c('Restaurant.', 'Food.Category.', 'Item_Name.', 
                           'Menu_Item_ID'))
df$year <- df$variable
levels(df$year) <- str_match(levels(df$variable), "[0-9]{4}")
levels(df$variable) <- gsub('\\.{1,2}', '', levels(df$variable))#remove dots
levels(df$variable) <- gsub('[0-9]', '', levels(df$variable))#remove year
levels(df$variable) <- gsub('\\s+$', '', levels(df$variable))#remove trailing space
df<-dcast(df, Restaurant. + Food.Category. + Item_Name. + Menu_Item_ID + year ~ 
           variable , value.var = 'value')
df<-arrange(df, Restaurant., Item_Name.)
```

### Menustat data

To refresh, the current dataset consists of over 180,000 observations, consisting of food items from 3 years (2014, 2013, and 2012).  The variables indicate the restaurant which serves the food item, the category that item falls into (e.g. entree, appetizer, etc), the year, and then nutrition information.  In this post, I'm going to make some preliminary plots, focusing on calories plus the macronutrients - carbs, proteins, and fats.  For ease of examination, I'm going to plot these as a function of which food category they belong to.
```{r, message=FALSE, warning=FALSE}
library(ggplot2)
library(dplyr)
df$Calories <- as.numeric(df$Calories)
ordered.df <- group_by(df, Food.Category.) %>%
  summarise(med = median(Calories, na.rm=T)) %>%
  arrange(desc(med)) %>%
  as_data_frame()
df$Food.Category. <- factor(df$Food.Category., levels=ordered.df$Food.Category.)

plot <- ggplot(df, aes(x=Food.Category., y=Calories))
plot + geom_boxplot(fill='#ABC3CE') +
  xlab('Food Category') + 
  theme_bw() + 
  theme(axis.text.x = element_text(angle=15, vjust=.9))
```

I've also taken the liberty of ordering the x axis according to median, descending from left to right.  Nothing especially surprising here.  Biggest calorie bombs are Burgers, Entrees, and Sandwiches.  One Burger tips the scales at around 5000 calories, and while that's around 2 days worth of the recommended daily energy needs for the average male, I guess it isn't *too* surprising.  This *is* the land of the free and home of the brave, after all.  Next up is carbs:

```{r, warning=FALSE}
df$Carbohydratesg <- as.numeric(df$Carbohydratesg)
ordered.df <- group_by(df, Food.Category.) %>%
  summarise(med = median(Carbohydratesg, na.rm=T)) %>%
  arrange(desc(med)) %>%
  as_data_frame()
df$Food.Category. <- factor(df$Food.Category., levels=ordered.df$Food.Category.)


plot <- ggplot(df, aes(x=Food.Category., y=Carbohydratesg))
plot + geom_boxplot(fill='#ABC3CE') +
  xlab('Food Category') + ylab('Carbohydrates') + 
  theme_bw() + 
  theme(axis.text.x = element_text(angle=15, vjust=.9))
```

This is a bit odd.  There's apparently a side or appetizer which has north of 800 grams of carbohydrates.  I find this hard to believe.  Let's look a little more closely.

```{r}
subset(df, df$Carbohydratesg > 800)
```

Ah!  My old alma mater!  I spent about 7 months employed by Red Robin in the year between undergrad and my master's program at SFSU.  It let me pay off the absurd costs incurred by applying to graduate school in my first attempt.  Anyway, this seems to say that there are 838 grams of carbohydrates in 313 calories worth of Guac & Salsa with chips.  I don't know that I believe this.  Let's look at the rows around it (where the same item for 2013 and 2012 should appear)

```{r}
df[131161:131163,]
```

Well, 2013 seems to be about as expected.  2014, however, seems to be a lost cause.  I even did a bit of poking around on the web to see if I could find some better information, but there doesn't seem to be anything on the first page or two of google.  We'll replace these carb count here with NA and replot.

```{r, warning=FALSE}
df$Carbohydratesg[131161] <- NA
plot <- ggplot(df, aes(x=Food.Category., y=Carbohydratesg))
plot + geom_boxplot(fill='#ABC3CE') +
  xlab('Food Category') + ylab('Carbohydrates') + 
  theme_bw() +
  theme(axis.text.x = element_text(angle=15, vjust=.9))
```

That's much better.  On to protein:

```{r, warning=FALSE}
df$Proteing <- as.numeric(df$Proteing)
ordered.df <- group_by(df, Food.Category.) %>%
  summarise(med = median(Proteing, na.rm=T)) %>%
  arrange(desc(med)) %>%
  as_data_frame()
df$Food.Category. <- factor(df$Food.Category., levels=ordered.df$Food.Category.)

plot <- ggplot(df, aes(x=Food.Category., y=Proteing))
plot + geom_boxplot(fill='#ABC3CE') +
  xlab('Food Category') + ylab('Protein') + 
  theme_bw() +
  theme(axis.text.x = element_text(angle=15, vjust=.9))
```

Okay, a few oddities.  A couple of `Toppings & Ingredients' with quite a bit more protein than one would think.  Also, there's a burger with over 300 grams of protein.  I'll bet it's the one with 5000 calories.

```{r}
subset(df, df$Proteing > 240)
```

First of all, behold the [Landfill Burger][ref1].  Yikes.  That is the definition of an outlier.  Still, I see no reason to remove it or anything.  That's a real thing.  A real burger.

Moving on, we see the sides of Blue Cheese and Ranch dressing.  Popular among body builders as a quick dose of protein immediately following a workout...

Except not at all.  Let's first try to correct these two observations by looking at the neighboring rows.

```{r}
df[75619:75621,]
```

Okay, I think we can safely correct that value of 300 grams of protein to a 3.  While we're at it, we can also fix the sodium figure for the same year.

```{r}
df[75620, 16] <- 300
df[75620, 21] <- 3
```

For ranch dressing:

```{r}
df[75814:75816,]
```

Same problem!  Someone switched the numbers somewhere.  

```{r}
df[75815, 16] <- 250
df[75815, 21] <- 3
```

Replot:

```{r, warning=FALSE}
plot <- ggplot(df, aes(x=Food.Category., y=Proteing))
plot + geom_boxplot(fill='#ABC3CE') +
  xlab('Food Category') + ylab('Protein') + 
  theme_bw() +
  theme(axis.text.x = element_text(angle=15, vjust=.9))
```

Okay, that's much better.  Last, let's look at fat:

```{r, warning=FALSE}
df$TotalFatg <- as.numeric(df$TotalFatg)
ordered.df <- group_by(df, Food.Category.) %>%
  summarise(med = median(TotalFatg, na.rm=T)) %>%
  arrange(desc(med)) %>%
  as_data_frame()
df$Food.Category. <- factor(df$Food.Category., levels=ordered.df$Food.Category.)


plot <- ggplot(df, aes(x=Food.Category., y=TotalFatg))
plot + geom_boxplot(fill='#ABC3CE') +
  xlab('Food Category') + ylab('Total Fat') + 
  theme_bw() +
  theme(axis.text.x = element_text(angle=15, vjust=.9))
```

One more offender in toppings & ingredients.  

```{r}
subset(df, df$TotalFatg > 300)
```

Yeah, no way a yellow rice & veg bowl has 320 grams of fat.

```{r}
df[122305:122307,]
```

Looks like the calories and the fat here are both entered incorrectly.  I'm tempted to make both of them the same as what is found on row 122306 (i.e. 320 calories, 5 grams of fat), but row 122306 specifies in the item description that the item is 10 ounces.  There's no such description in the offending row.  So, I think I'll just remove these mis-entered numbers.

```{r}
df[122305,12] <- NA
df[122305,11] <- NA
```

replot:

```{r, warning=FALSE}
plot <- ggplot(df, aes(x=Food.Category., y=TotalFatg))
plot + geom_boxplot(fill='#ABC3CE') +
  xlab('Food Category') + ylab('Total Fat') + 
  theme_bw() +
  theme(axis.text.x = element_text(angle=15, vjust=.9))
```

Our variables of interest are now relatively clean, and we can proceed with some more interesting analyses.  This will be the subject of a subsequent post.

[img1]: <menustat_text.png>
[ref2]:  <http://api.ning.com/files/drL7ji10lw0df0UGzfzR3Wgna8ZmVV2JSf-ebXK3ggx1hTZlYsoH5*nmXIW9-QjqmRicEjoeROQZ4I*FS3FQKPxRpAZuKxwx/100_0218.JPG?width=737&height=552>